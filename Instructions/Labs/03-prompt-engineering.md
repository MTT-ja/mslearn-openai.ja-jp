---
lab:
    title: 'アプリでプロンプトエンジニアリングを活用する'
---

# アプリでプロンプトエンジニアリングを活用する

Azure OpenAIサービスを使用する際、開発者がプロンプトをどのように形成するかは、生成AIモデルがどのように応答するかに大きく影響します。Azure OpenAIモデルは、明確で簡潔な方法で要求された場合、コンテンツを調整しフォーマットすることができます。この演習では、類似のコンテンツに対する異なるプロンプトが、AIモデルの応答を形作り、要件をより満たすためにどのように役立つかを学びます。

この演習には約**25**分かかります。

## Azure OpenAIリソースのプロビジョニング

まだお持ちでない場合は、AzureサブスクリプションにAzure OpenAIリソースをプロビジョニングしてください。

1. `https://portal.azure.com`で**Azureポータル**にサインインします。
2. 次の設定で**Azure OpenAI**リソースを作成します：
    - **サブスクリプション**: *Azure OpenAIサービスへのアクセスが承認されたAzureサブスクリプションを選択*
    - **リソースグループ**: *リソースグループを選択または作成*
    - **リージョン**: *利用可能なリージョンから**ランダム**に選択*\*
    - **名前**: *お好きなユニークな名前*
    - **価格レベル**: Standard S0

    > \* Azure OpenAIリソースはリージョナルなクォータによって制限されています。ランダムにリージョンを選択することで、他のユーザーとサブスクリプションを共有するシナリオで単一のリージョンがクォータ制限に達するリスクを減らすことができます。演習の後半でクォータ制限に達した場合、別のリージョンで別のリソースを作成する必要があるかもしれません。

3. デプロイが完了するのを待ちます。その後、AzureポータルでデプロイされたAzure OpenAIリソースに移動します。

## モデルのデプロイ

Azure OpenAIは、**Azure OpenAI Studio**というWebベースのポータルを提供しており、モデルのデプロイ、管理、探索を行うことができます。Azure OpenAIの探索を開始するために、Azure OpenAI Studioを使用してモデルをデプロイします。

1. Azure OpenAIリソースの**概要**ページで、**Azure OpenAI Studioに移動**ボタンを使用して、新しいブラウザタブでAzure OpenAI Studioを開きます。
2. Azure OpenAI Studioで、**デプロイ**ページに移動し、既存のモデルデプロイを表示します。まだお持ちでない場合は、以下の設定で**gpt-35-turbo-16k**モデルの新しいデプロイを作成します：
    - **モデル**: gpt-35-turbo-16k *(16kモデルが利用できない場合は、gpt-35-turboを選択)*
    - **モデルバージョン**: デフォルトに自動更新
    - **デプロイ名**: *お好きなユニークな名前。この名前は後でラボで使用します。*
    - **詳細オプション**
        - **コンテンツフィルター**: デフォルト
        - **分あたりのトークン数制限**: 5K\*
        - **動的クォータの有効化**: 有効

    > \* 分あたり5,000トークンの制限は、この演習を完了するのに十分であり、同じサブスクリプションを使用する他の人のための容量も残しておきます。

## プロンプトエンジニアリング技術の探索

まず、チャットプレイグラウンドでいくつかのプロンプトエンジニアリング技術を探ってみましょう。

1. `https://oai.azure.com`の**Azure OpenAI Studio**で、**プレイグラウンド**セクションの**チャット**ページを選択します。**チャット**プレイグラウンドページは、以下の3つの主要なセクションで構成されています：
    - **アシスタント設定** - モデルの応答の文脈を設定するために使用されます。
    - **チャットセッション** - チャットメッセージを送信し、応答を表示するために使用されます。
    - **構成** - モデルデプロイの設定を構成するために使用されます。
2. **構成**セクションで、モデルデプロイが選択されていることを確認します。
3. **アシスタント設定**エリアで、デフォルトのシステムメッセージテンプレートを選択し、チャットセッションの文脈を設定します。デフォルトのシステムメッセージは*あなたは人々が情報を見つけるのを助けるAIアシスタントです*です。
4. **チャットセッション**で、以下のクエリを送信します：

    ```
    これはどのような記事ですか？
    ---
    カリフォルニアで深刻な干ばつの可能性
    
    数百万人のカリフォルニア州民が、干ばつが地域の広い範囲に成長する水不足をもたらすと脅かしているため、水が少なくなり、芝生が乾くことに備えています。
    
    干ばつの深刻さを示す顕著な兆候として、南カリフォルニアの当局は、約800万人の住民に対して週に1日だけの屋外での水使用を制限する前例のない行動を宣言しました。
    
    日常生活がどのように変わるかについては、人々がより乾燥した通常の状態に適応するにつれて、まだ多くが決定されていません。しかし、当局は状況が深刻であり、年後半にはさらに厳しい制限が課される可能性があると警告しています。
    ```

    応答は記事の説明を提供します。しかし、記事の分類にもっと具体的な形式を求めたいとします。

5. **アシスタント設定**セクションで、システムメッセージを`あなたはニュース記事を分類するニュースアグリゲーターです。`に変更します。

6. 新しいシステムメッセージの下で、**例を追加**ボタンを選択します。以下の例を追加します。

    **ユーザー:**
    
    ```
    これはどのような記事ですか？
    ---
    ニューヨークの野球選手がシカゴに大勝
    
    昨夜、ニューヨークの野球選手はシカゴサイクロンズに対して大きな5-0の完封勝利を収め、7回裏に3ランホームランで勝利を固めました。
    
    ニューヨークのピッチャー、マリオ・ロジャースは96球を投げ、たった2ヒットで、今年最高のパフォーマンスをマークしました。
    
    シカゴサイクロンズの2ヒットは2回と5回に出ましたが、ランナーをホームに帰して得点することはできませんでした。
    ```
    
    **アシスタント:**
    
    ```
    スポーツ
    ```

7. 次のテキストで別の例を追加します。

    **ユーザー:**
    
    ```
    この記事を分類してください：
    ---
    オスカー賞での喜びの瞬間
    
    先週のオスカー賞は本当に何かがありました！
    
    あるスキャンダルがショーを盗んだかもしれませんが、今年のアカデミー賞には、私たちを喜びで満たし、涙さえも誘う瞬間がたくさんありました。
    これらの俳優と女優は、冬を乗り切るために、本当に感動的なパフォーマンスと素晴らしい笑いを提供しました。
    
    ロビン・クラインの歴史的な勝利から、ケーシー・ジェンセン自身によるフルパフォーマンスまで、明日のお祭りの再放送をお見逃しなく。
    ```
    
    **アシスタント:**
    
    ```
    エンターテイメント
    ```

8. **アシスタント設定**セクションの上部にある**変更を保存**ボタンを使用して、システムメッセージを更新します。

9. **チャットセッション**セクションで、以下のプロンプトを再送信します：

    ```
    これはどのような記事ですか？
    ---
    カリフォルニアで深刻な干ばつの可能性
    
    数百万人のカリフォルニア州民が、干ばつが地域の広い範囲に成長する水不足をもたらすと脅かしているため、水が少なくなり、芝生が乾くことに備えています。
    
    干ばつの深刻さを示す顕著な兆候として、南カリフォルニアの当局は、約800万人の住民に対して週に1日だけの屋外での水使用を制限する前例のない行動を宣言しました。
    
    日常生活がどのように変わるかについては、人々がより乾燥した通常の状態に適応するにつれて、まだ多くが決定されていません。しかし、当局は状況が深刻であり、年後半にはさらに厳しい制限が課される可能性があると警告しています。
    ```

    より具体的なシステムメッセージと期待されるクエリと応答の例の組み合わせにより、結果の一貫した形式が得られます。

10. **アシスタント設定**セクションで、システムメッセージをデフォルトのテンプレートに戻し、例がない状態で`あなたは人々が情報を見つけるのを助けるAIアシスタントです。`に設定して、変更を保存します。

11. **チャットセッション**セクションで、以下のプロンプトを送信します：

    ```
    # 1. 動物のリストを作成する
    # 2. それらの動物に対して風変わりな名前のリストを作成する
    # 3. 25組の動物と名前のペアをランダムに組み合わせる
    ```

    モデルは、番号付きリストに分けられたプロンプトに対する適切な応答を提供する可能性が高いです。これは適切な応答ですが、実際には説明したタスクを実行するPythonプログラムをモデルに書いてもらいたかったとします。

12. システムメッセージを`あなたはPythonコードを書くのを助けるコーディングアシスタントです。`に変更し、**変更を保存**をクリックします。
13. 以下のプロンプトをモデルに再送信します：

    ```
    # 1. 動物のリストを作成する
    # 2. それらの動物に対して風変わりな名前のリストを作成する
    # 3. 25組の動物と名前のペアをランダムに組み合わせる
    ```

    モデルは、コメントで要求されたことを実行するPythonコードで正しく応答するはずです。

## Visual Studio Codeでアプリの開発準備をする

Azure OpenAIサービスSDKを使用するアプリでプロンプトエンジニアリングの使用を探ってみましょう。アプリの開発にはVisual Studio Codeを使用します。アプリのコードファイルはGitHubリポジトリに提供されています。

> **ヒント**: すでに**mslearn-openai**リポジトリをクローンしている場合は、Visual Studio Codeで開いてください。そうでない場合は、以下の手順に従って開発環境にクローンしてください。

1. Visual Studio Codeを起動します。
2. パレットを開く（SHIFT+CTRL+P）し、**Git: Clone**コマンドを実行して`https://github.com/MicrosoftLearning/mslearn-openai`リポジトリをローカルフォルダにクローンします（どのフォルダでも構いません）。
3. リポジトリがクローンされたら、Visual Studio Codeでフォルダを開きます。
4. リポジトリ内のC#コードプロジェクトをサポートするための追加ファイルがインストールされるのを待ちます。

    > **注**: ビルドとデバッグに必要なアセットを追加するように求められた場合は、**今はしない**を選択してください。

## アプリケーションを設定する

C#とPythonの両方のアプリケーションが提供されており、要約のテストに使用するサンプルテキストファイルもあります。どちらのアプリも同じ機能を備えています。まず、Azure OpenAIリソースを使用するためにアプリケーションのいくつかの重要な部分を完成させます。

1. Visual Studio Codeで、**エクスプローラー**ペインを開き、**Labfiles/03-prompt-engineering**フォルダに移動し、言語の好みに応じて**CSharp**または**Python**フォルダを展開します。各フォルダには、Azure OpenAI機能を統合するアプリの言語固有のファイルが含まれています。
2. コードファイルが含まれている**CSharp**または**Python**フォルダを右クリックし、統合ターミナルを開きます。次に、言語の好みに応じた適切なコマンドを実行してAzure OpenAI SDKパッケージをインストールします：

    **C#**:

    ```
    dotnet add package Azure.AI.OpenAI --version 1.0.0-beta.9
    ```

    **Python**:

    ```
    pip install openai==1.2.0
    ```

3. **エクスプローラー**ペインの**CSharp**または**Python**フォルダで、好みの言語の構成ファイルを開きます。

    - **C#**: appsettings.json
    - **Python**: .env
    
4. 構成値を更新して以下を含めます：
    - Azure OpenAIリソースから作成した**エンドポイント**と**キー**（AzureポータルのAzure OpenAIリソースの**キーとエンドポイント**ページで利用可能）
    - モデルデプロイメントに指定した**モデル名**（Azure OpenAI Studioの**デプロイ**ページで利用可能）。
5. 構成ファイルを保存します。

## Azure OpenAIサービスを使用するコードを追加する

これで、デプロイされたモデルを使用するためにAzure OpenAI SDKを使用する準備が整いました。

1. **エクスプローラー**ペインの**CSharp**または**Python**フォルダで、好みの言語のコードファイルを開き、***Add Azure OpenAI package***というコメントをAzure OpenAI SDKライブラリを追加するコードに置き換えます：

    **C#**: Program.cs

    ```csharp
    // Add Azure OpenAI package
    using Azure.AI.OpenAI;
    ```

    **Python**: prompt-engineering.py

    ```python
    # Add Azure OpenAI package
    from openai import AzureOpenAI
    ```

2. コードファイルで、***Configure the Azure OpenAI client***というコメントを見つけ、Azure OpenAIクライアントを設定するコードを追加します：

    **C#**: Program.cs

    ```csharp
    // Configure the Azure OpenAI client
    OpenAIClient client = new OpenAIClient(new Uri(oaiEndpoint), new AzureKeyCredential(oaiKey));
    ```

    **Python**: prompt-engineering.py

    ```python
    # Configure the Azure OpenAI clientt
    client = AzureOpenAI(
            azure_endpoint = azure_oai_endpoint, 
            api_key=azure_oai_key,  
            api_version="2023-05-15"
            )
    ```

3. Azure OpenAIモデルを呼び出す関数で、***Format and send the request to the model***というコメントの下に、モデルへのリクエストをフォーマットして送信するコードを追加します。

    **C#**: Program.cs

    ```csharp
    // Format and send the request to the model
    var chatCompletionsOptions = new ChatCompletionsOptions()
    {
        Messages =
        {
            new ChatMessage(ChatRole.System, systemPrompt),
            new ChatMessage(ChatRole.User, userPrompt)
        },
        Temperature = 0.7f,
        MaxTokens = 800,
        DeploymentName = oaiModelName
    };
    
    // Get response from Azure OpenAI
    Response<ChatCompletions> response = await client.GetChatCompletionsAsync(chatCompletionsOptions);
    
    ChatCompletions completions = response.Value;
    string completion = completions.Choices[0].Message.Content;
    ```

    **Python**: prompt-engineering.py

    ```python
    # Format and send the request to the model
    messages =[
        {"role": "system", "content": system_message},
        {"role": "user", "content": user_message},
    ]
    
    # Call the Azure OpenAI model
    response = client.chat.completions.create(
        model=model,
        messages=messages,
        temperature=0.7,
        max_tokens=800
    )
    ```

4. コードファイルの変更を保存します。

## アプリケーションを実行する

アプリが設定されたので、実行してモデルにリクエストを送り、応答を観察しましょう。異なるオプション間で唯一の違いはプロンプトの内容であり、他のパラメータ（トークン数や温度など）は各リクエストで同じです。

各プロンプトは、プロンプトの違いがどのように異なる応答を生むかを見るために、送信されるとコンソールに表示されます。

1. **エクスプローラー**ペインで、**Labfiles/03-prompt-engineering/prompts**フォルダを展開し、含まれている各テキストファイルを見てください。これらのテキストファイルには、アプリがモデルに送信できるさまざまなプロンプトが含まれています。

2. インタラクティブなターミナルペインで、お好みの言語のフォルダコンテキストを確認してください。次に、アプリケーションを実行するために以下のコマンドを入力します。

    - **C#**: `dotnet run`
    - **Python**: `python prompt-engineering.py`

    > **ヒント**: ターミナルツールバーの**パネルサイズを最大化**（**^**）アイコンを使用して、コンソールテキストをより多く表示できます。

3. 最も基本的なプロンプトのオプション**1**を選択します。次に、プロンプト入力と生成された出力を観察してください。AIモデルは、野生動物救助についての良い一般的な紹介を生成する可能性が高いです。
4. 次に、オプション**2**を選択して、野生動物救助についての詳細と共にイントロメールのプロンプトを送信してみてください。今回は、特定の動物が含まれたメールの形式と、寄付の呼びかけが見られる可能性が高いです。
5. 次に、オプション**3**を選択して、前回と同様のメールを依頼しますが、追加の動物が含まれた整形式のテーブルがあるものを依頼してみてください。
6. 次に、オプション**4**を選択して、別のメールを依頼しますが、今回はシステムメッセージの異なるトーンを指定してみてください。今回は、同様の形式のメールが表示される可能性が高いですが、はるかにカジュアルなトーンであることがわかります。冗談が含まれている可能性もあります！

    > **ヒント**: Azure OpenAIからの完全な応答を見たい場合は、**printFullResponse**変数を`True`に設定して、アプリを再実行できます。

## クリーンアップ

Azure OpenAIリソースの使用が終わったら、**Azureポータル**の`https://portal.azure.com`でデプロイメントを削除するか、リソース全体を削除することを忘れないでください。
